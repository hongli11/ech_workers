name: Build and Release ARMv7

on:
  push:
    tags:
      - 'v*'  # 只在你 push 到以 v 开头的 tag 时触发
  workflow_dispatch:  # 手动触发
    inputs:
      tag_name:
        description: 'Tag Name'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up Rust
      - name: Set up Rust
        uses: actions/setup-rust@v1
        with:
          rust-version: 1.60.0

      # Build the project
      - name: Build the project
        run: |
          cargo build --release --target=armv7-unknown-linux-gnueabihf
          
      # Create a release and upload the binary
      - name: Create Release and Upload Binary
        uses: softprops/action-gh-release@v1
        with:
          files: ./target/armv7-unknown-linux-gnueabihf/release/ech-workers-armv7

      # Optional: Deploy to a server via SCP (uncomment if needed)
      - name: Upload to server
        if: success()  # Only run if build succeeds
        run: |
          echo "Uploading to server..."
          scp ./target/armv7-unknown-linux-gnueabihf/release/ech-workers-armv7 user@yourserver:/path/to/deploy/
          ssh user@yourserver "chmod +x /path/to/deploy/ech-workers-armv7 && /path/to/deploy/ech-workers-armv7"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
